rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ─────────────────────────────────────────────────────────────────
    //  HELPER FUNCTIONS
    // ─────────────────────────────────────────────────────────────────

    // Returns true if the requester is signed in
    function isAuthenticated() {
      return request.auth != null;
    }

    // Returns true if the requester owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Returns true if the requester is the admin
    function isAdmin() {
      return isAuthenticated() && (
        request.auth.token.email.lower() == "fortunedomination@gmail.com" ||
        (
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
        )
      );
    }

    // Helper: fields that regular users cannot self-modify
    function isModifyingProtectedUserFields() {
      return request.resource.data.diff(resource.data).affectedKeys()
        .hasAny(['role', 'ownedNFT', 'referralCount', 'registrationIP']);
    }

    // ─────────────────────────────────────────────────────────────────
    //  USERS COLLECTION
    //  - Read:   Any authenticated user (leaderboard, referral checks)
    //  - Create: Owner only, with safe defaults on protected fields
    //  - Update: Admin OR owner without touching protected fields
    //  - Delete: Admin only
    // ─────────────────────────────────────────────────────────────────
    match /users/{userId} {
      allow read:   if isAuthenticated();

      allow create: if isOwner(userId)
                    && (!('role' in request.resource.data) || request.resource.data.role == 'user' || request.auth.token.email.lower() == "fortunedomination@gmail.com")
                    && (!('ownedNFT' in request.resource.data) || request.resource.data.ownedNFT == false)
                    && (!('referralCount' in request.resource.data) || request.resource.data.referralCount == 0)
                    && (!('registrationIP' in request.resource.data));

      allow update: if isAdmin() || (isOwner(userId) && !isModifyingProtectedUserFields());

      allow delete: if isAdmin();
    }

    // ─────────────────────────────────────────────────────────────────
    //  USERNAMES  (uniqueness reservation)
    //  - Read/Create: Authenticated (check & claim)
    //  - Update/Delete: Admin only
    // ─────────────────────────────────────────────────────────────────
    match /usernames/{username} {
      allow read, create:   if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // ─────────────────────────────────────────────────────────────────
    //  TASKS
    //  - Read:  Anyone (public task feed)
    //  - Write: Admin only
    // ─────────────────────────────────────────────────────────────────
    match /tasks/{taskId} {
      allow read:  if true;
      allow write: if isAdmin();
    }

    // ─────────────────────────────────────────────────────────────────
    //  SITE CONTENT  (CMS, access control)
    //  - Read:  Anyone (landing pages, access control checks)
    //  - Write: Admin only
    // ─────────────────────────────────────────────────────────────────
    match /site_content/{docId} {
      allow read:  if true;
      allow write: if isAdmin();
    }

    // ─────────────────────────────────────────────────────────────────
    //  GLOBAL STATS  (network counters displayed on Dashboard)
    //  - Read:   Anyone
    //  - Update: Authenticated user — only allowed counter fields
    //  - Create/Delete: Admin only
    // ─────────────────────────────────────────────────────────────────
    match /global_stats/{statId} {
      allow read: if true;

      // Authenticated users may only increment specific counters
      allow update: if isAuthenticated()
                    && request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['totalMined', 'totalUsers', 'activeNodes', 'maxUsersCap']);

      allow create, delete: if isAdmin();
    }

    // ─────────────────────────────────────────────────────────────────
    //  CONTACT MESSAGES  (support inbox)
    //  - Create: Authenticated users (prevents anonymous spam)
    //  - Read/Update/Delete: Admin only
    // ─────────────────────────────────────────────────────────────────
    match /contact_messages/{messageId} {
      allow create:               if isAuthenticated();
      allow read, update, delete: if isAdmin();
    }

    // ─────────────────────────────────────────────────────────────────
    //  WALLET TRANSACTIONS  (DEX Vault transaction history)
    //  - Create: Authenticated user, only for their own UID
    //  - Read:   Owner only (private financial data)
    //  - Update: Forbidden (immutable ledger)
    //  - Delete: Admin only
    // ─────────────────────────────────────────────────────────────────
    match /wallet_transactions/{txId} {
      allow create: if isAuthenticated()
                    && request.resource.data.uid == request.auth.uid
                    && request.resource.data.keys().hasAll(['uid', 'chain', 'type', 'amount', 'status', 'txHash', 'createdAt'])
                    && request.resource.data.chain in ['ARG', 'ETH']
                    && request.resource.data.type in ['SEND', 'RECEIVE', 'MINT', 'REWARD']
                    && request.resource.data.status in ['CONFIRMED', 'PENDING', 'FAILED']
                    && request.resource.data.amount is string
                    && request.resource.data.createdAt is number;

      allow read:   if isOwner(resource.data.uid);

      // Transactions are immutable — no updates allowed
      allow update: if false;

      // Only admin can remove records
      allow delete: if isAdmin();
    }

    // ─────────────────────────────────────────────────────────────────
    //  CATCH-ALL DENY
    //  Denies any document path not explicitly matched above.
    // ─────────────────────────────────────────────────────────────────
    match /{document=**} {
      allow read, write: if false;
    }

  }
}