rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ─────────────────────────────────────────────────────────────────
    //  HELPER FUNCTIONS
    // ─────────────────────────────────────────────────────────────────

    // Returns true if the requester is signed in
    function isAuthenticated() {
      return request.auth != null;
    }

    // Returns true if the requester owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Returns true if the requester is an admin (by email or by role field)
    function isAdmin() {
      return isAuthenticated() && (
        request.auth.token.email.lower() == "fortunedomination@gmail.com" ||
        (
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
        )
      );
    }

    // Helper to check if an update safely avoids protected fields
    function isModifyingProtectedUserFields() {
      return request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'ownedNFT', 'referralCount']);
    }

    // ─────────────────────────────────────────────────────────────────
    //  USERS COLLECTION
    //  Read:   Anyone (required for leaderboard / network stats)
    //  Create: Only the user themselves (during registration)
    //  Update: Owner (for mining) or admin
    //  Delete: Admin only
    // ─────────────────────────────────────────────────────────────────
    match /users/{userId} {
      allow read:   if true;
      allow create: if isOwner(userId) 
                    && (!('role' in request.resource.data) || request.resource.data.role == 'user' || request.auth.token.email.lower() == "fortunedomination@gmail.com")
                    && (!('ownedNFT' in request.resource.data) || request.resource.data.ownedNFT == false)
                    && (!('referralCount' in request.resource.data) || request.resource.data.referralCount == 0);
      allow update: if isAdmin() || (isOwner(userId) && !isModifyingProtectedUserFields());
      allow delete: if isAdmin();
    }

    // ─────────────────────────────────────────────────────────────────
    //  USERNAMES COLLECTION  (uniqueness reservation)
    //  Read:   Anyone (to check availability before registering)
    //  Create: Any authenticated user (claim their username)
    //  Update / Delete: Admin only
    // ─────────────────────────────────────────────────────────────────
    match /usernames/{username} {
      allow read:          if true;
      allow create:        if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // ─────────────────────────────────────────────────────────────────
    //  TASKS COLLECTION
    //  Read:   Anyone (to display available tasks)
    //  Write:  Admin only
    // ─────────────────────────────────────────────────────────────────
    match /tasks/{taskId} {
      allow read:  if true;
      allow write: if isAdmin();
    }

    // ─────────────────────────────────────────────────────────────────
    //  SITE CONTENT (CMS)
    //  Read:   Anyone (landing pages, etc.)
    //  Write:  Admin only
    // ─────────────────────────────────────────────────────────────────
    match /site_content/{docId} {
      allow read:  if true;
      allow write: if isAdmin();
    }

    // ─────────────────────────────────────────────────────────────────
    //  GLOBAL STATS  (network metrics displayed on dashboard)
    //  Read:   Anyone
    //  Update: Any authenticated user (increment mining counters)
    //  Create / Delete: Admin only
    // ─────────────────────────────────────────────────────────────────
    match /global_stats/{statId} {
      allow read:          if true;
      allow update:        if isAuthenticated() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['totalMined', 'totalUsers', 'activeNodes']);
      allow create, delete: if isAdmin();
    }

    // ─────────────────────────────────────────────────────────────────
    //  CONTACT MESSAGES
    //  Create: Anyone — public contact form, no login required
    //  Read / Update / Delete: Admin only — managed from Admin Panel inbox
    // ─────────────────────────────────────────────────────────────────
    match /contact_messages/{messageId} {
      allow create:               if true;
      allow read, update, delete: if isAdmin();
    }

  }
}